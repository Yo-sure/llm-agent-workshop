<!DOCTYPE html>
<html>

<head>
    <title>Trading Bot - Human Approval Interface</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }

        .chat-container {
            height: 800px;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }

        .system-message {
            background: #ecf0f1;
            color: #2c3e50;
            border-left: 4px solid #3498db;
        }

        .approval-request {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .approval-actions {
            margin-top: 10px;
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .status {
            padding: 10px 20px;
            background: #e8f5e8;
            color: #155724;
            text-align: center;
        }

        .input-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .input-group {
            display: flex;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .input-field {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 20px;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .dropdown-container {
            position: relative;
            flex: 1;
        }

        .dropdown-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .ticker-code {
            font-weight: bold;
            color: #007bff;
        }

        .company-name {
            color: #666;
            font-size: 12px;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #e9ecef;
            color: #495057;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .ticker {
            font-weight: bold;
            color: #007bff;
        }

        .action-buy {
            color: #28a745;
            font-weight: bold;
        }

        .action-sell {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>ğŸ¤– Trading Bot</h1>
        <p>Human-in-the-Loop Approval Interface</p>
    </div>
    <div class="status" id="status">
        ğŸ“¡ ì—°ê²° ëŒ€ê¸° ì¤‘...
    </div>
    <div class="input-section">
        <h3 style="text-align: center; margin-bottom: 15px;">ğŸ“Š ê±°ë˜ ë¶„ì„ ìš”ì²­</h3>
        <div class="input-group">
            <div class="dropdown-container">
                <input type="text" id="stockSearch" class="dropdown-input"
                       placeholder="ì¢…ëª©ëª… ë˜ëŠ” í‹°ì»¤ ê²€ìƒ‰ (ì˜ˆ: Apple, NVDA)" readonly onclick="toggleDropdown()">
                <div id="stockDropdown" class="dropdown-list">
                    <!-- ì£¼ì‹ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <button id="analyzeBtn" class="btn-primary" onclick="requestTradeAnalysis()" disabled>ë¶„ì„ ìš”ì²­</button>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
            <strong>ğŸ’¡ íŒ:</strong> ê²€ìƒ‰ì°½ì„ í´ë¦­í•˜ì—¬ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”
        </div>
    </div>
    <div class="chat-container" id="chatContainer">
        <div class="message system-message">
            <strong>ì‹œìŠ¤í…œ:</strong> ê±°ë˜ ìŠ¹ì¸ ì¸í„°í˜ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.
            ì—ì´ì „íŠ¸ê°€ BUY/SELL ê²°ì •ì„ ë‚´ë¦¬ë©´ ì—¬ê¸°ì„œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>
</div>

<script>
    let ws = null;
    let reconnectInterval = null;

    function wsUrl(path) {
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        return `${proto}://${location.host}${path}`;
    }

    function connect() {
        ws = new WebSocket(wsUrl('/ws'));

        ws.onopen = function (event) {
            console.log('WebSocket connected');
            document.getElementById('status').innerHTML = 'âœ… ì—°ê²°ë¨ - ìŠ¹ì¸ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
            document.getElementById('status').style.background = '#d4edda';

            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
        };

        ws.onmessage = function (event) {
            const message = JSON.parse(event.data);
            handleMessage(message);
        };

        ws.onclose = function (event) {
            console.log('WebSocket disconnected');
            document.getElementById('status').innerHTML = 'âŒ ì—°ê²° ëŠì–´ì§ - ì¬ì—°ê²° ì‹œë„ ì¤‘...';
            document.getElementById('status').style.background = '#f8d7da';

            // Auto-reconnect
            if (!reconnectInterval) {
                reconnectInterval = setInterval(connect, 3000);
            }
        };

        ws.onerror = function (error) {
            console.error('WebSocket error:', error);
        };
    }

    function addStageMessage(msg) {
        const {name, status, ticker, error} = msg;
        const chat = document.getElementById('chatContainer');
        const statusEl = document.getElementById('status');

        const div = document.createElement('div');
        div.className = 'message system-message';

        const final = msg.final || null;

        if (name === 'prelim') {
            if (status === 'start') {
                statusEl.innerHTML = `ğŸ“ˆ ${ticker || ''} ì‹œì¥ ë™í–¥ ë¶„ì„ ì¤‘...`;
                statusEl.style.background = '#cce5ff';
                div.innerHTML = `<strong>ğŸ“ˆ ë‹¨ê³„ ì‹œì‘:</strong> ì‹œì¥ ë™í–¥ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.`;
            } else if (status === 'done') {
                statusEl.innerHTML = `ğŸ“ˆ ì‹œì¥ ë™í–¥ ë¶„ì„ ì™„ë£Œ`;
                statusEl.style.background = '#e8f5e8';

                const action = (final?.action || 'HOLD').toUpperCase();
                const conf = (typeof final?.confidence === 'number') ? final.confidence.toFixed(2) : 'N/A';
                const reason = final?.reason || '';

                div.innerHTML = `<strong>âœ… ë‹¨ê³„ ì™„ë£Œ:</strong> ì´ˆì•ˆ íŒë‹¨ â†’ <b>${action}</b> (ì‹ ë¢°ë„: ${conf})<br/>ì‚¬ìœ : ${reason}`;
            }
        }

        if (name === 'news') {
            if (status === 'start') {
                statusEl.innerHTML = `ğŸ“° ${ticker || ''} ë‰´ìŠ¤ ê²€ì¦ ì¤‘...`;
                statusEl.style.background = '#cce5ff';
                div.innerHTML = `<strong>ğŸ“° ë‹¨ê³„ ì‹œì‘:</strong> ë‰´ìŠ¤ ìš”ì•½ì„ ì¡°íšŒ/ë°˜ì˜í•©ë‹ˆë‹¤.`;
            } else if (status === 'done') {
                if (error) {
                    statusEl.innerHTML = `âš ï¸ ë‰´ìŠ¤ ê²€ì¦ ì‹¤íŒ¨ - ë³´ìˆ˜ì  íŒë‹¨`;
                    statusEl.style.background = '#f8d7da';
                    div.innerHTML = `<strong>âš ï¸ ë‹¨ê³„ ì˜¤ë¥˜:</strong> ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨<br/>ì‚¬ìœ : ${error}`;
                } else {
                    statusEl.innerHTML = `ğŸ“° ë‰´ìŠ¤ ê²€ì¦ ì™„ë£Œ`;
                    statusEl.style.background = '#e8f5e8';
                    const hasNews = !!msg.has_news;
                    div.innerHTML = `<strong>âœ… ë‹¨ê³„ ì™„ë£Œ:</strong> ë‰´ìŠ¤ ${hasNews ? 'ë°˜ì˜ë¨' : 'ë°ì´í„° ì—†ìŒ'}`;
                }
            }
        }

        if (name === 'final') {
            if (status === 'start') {
                statusEl.innerHTML = `ğŸ§® ìµœì¢… íŒë‹¨ ì¤‘...`;
                statusEl.style.background = '#cce5ff';
                div.innerHTML = `<strong>ğŸ§® ë‹¨ê³„ ì‹œì‘:</strong> ì´ˆì•ˆ + ë‰´ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ìµœì¢… ê²°ì •ì„ ì‚°ì¶œí•©ë‹ˆë‹¤.`;
            } else if (status === 'done') {
                statusEl.innerHTML = `âœ… ìµœì¢… íŒë‹¨ ì™„ë£Œ`;
                statusEl.style.background = '#d4edda';

                const action = (final?.final?.action || final?.action || 'HOLD').toUpperCase();
                const conf = (typeof (final?.final?.confidence ?? final?.confidence) === 'number')
                    ? (final?.final?.confidence ?? final?.confidence).toFixed(2)
                    : 'N/A';

                div.innerHTML = `<strong>âœ… ë‹¨ê³„ ì™„ë£Œ:</strong> ìµœì¢… íŒë‹¨ ìƒì„± â†’ <b>${action}</b> (ì‹ ë¢°ë„: ${conf})`;
            }
        }

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }


    function handleMessage(message) {
        if (message.type === 'approval_request') {
            const request = message.data;
            addApprovalRequest(request);
        } else if (message.type === 'approval_processed') {
            document.getElementById('status').innerHTML = 'âœ… ìŠ¹ì¸ ì²˜ë¦¬ ì™„ë£Œ - ë‹¤ìŒ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
            document.getElementById('status').style.background = '#d4edda';
        } else if (message.type === 'stage') {
            addStageMessage(message);
        } else if (message.type === 'trade') {
            addTradeMessage(message);
        } else if (message.type === 'system') {
            // í•„ìš” ì‹œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬ (í˜„ì¬ëŠ” ìƒíƒœë°”ë§Œ ì‚¬ìš©)
        } else if (message.type === 'ping') {
            // keep-alive: ë¬´ì‹œ
        }
    }

    function addApprovalRequest(request) {
        const chatContainer = document.getElementById('chatContainer');

        // ì¤‘ë³µ ë Œë” ë°©ì§€
        if (document.querySelector(`[data-reqid="${request.request_id}"]`)) {
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message approval-request';
        messageDiv.id = `request-${request.request_id}`;
        messageDiv.setAttribute('data-reqid', request.request_id);

        const action = (request.action || '').toUpperCase();
        const actionClass = action === 'BUY' ? 'action-buy' : (action === 'SELL' ? 'action-sell' : '');

        messageDiv.innerHTML = `
                <div><strong>ğŸ”” ê±°ë˜ ìŠ¹ì¸ ìš”ì²­</strong></div>
                <div style="margin: 10px 0;">
                    <div><strong>ì¢…ëª©:</strong> <span class="ticker">${request.ticker}</span></div>
                    <div><strong>ì•¡ì…˜:</strong> <span class="${actionClass}">${action || '-'}</span></div>
                    <div><strong>ê·¼ê±°:</strong> ${request.reason || '-'}</div>
                    <div><strong>ì‹œê°„:</strong> ${new Date(request.timestamp * 1000).toLocaleString()}</div>
                </div>
                <div class="approval-actions">
                    <button class="btn btn-approve" onclick="processApproval('${request.request_id}', true)">âœ… ìŠ¹ì¸</button>
                    <button class="btn btn-reject"  onclick="processApproval('${request.request_id}', false)">âŒ ê±°ë¶€</button>
                </div>
            `;

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        document.getElementById('status').innerHTML = `ğŸ”” ìŠ¹ì¸ ìš”ì²­: ${request.ticker} ${action || ''}`;
        document.getElementById('status').style.background = '#fff3cd';
    }

    function processApproval(requestId, approved) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const response = {
                type: 'approval_response',
                request_id: requestId,
                approved: approved,
                timestamp: Date.now() / 1000
            };

            ws.send(JSON.stringify(response));

            // Update UI
            const requestDiv = document.getElementById(`request-${requestId}`);
            if (requestDiv) {
                const result = approved ? 'âœ… ìŠ¹ì¸ë¨' : 'âŒ ê±°ë¶€ë¨';
                const resultClass = approved ? 'btn-approve' : 'btn-reject';

                requestDiv.querySelector('.approval-actions').innerHTML =
                    `<span class="btn ${resultClass}" style="cursor: default;">${result}</span>`;
            }

            document.getElementById('status').innerHTML = 'â³ ê±°ë˜ ì²˜ë¦¬ ì¤‘...';
            document.getElementById('status').style.background = '#cce5ff';
        }
    }

    function addTradeMessage(msg) {
        const chat = document.getElementById('chatContainer');
        const {ticker, order} = msg;

        const qty = order.qty ?? order.quantity ?? order.shares ?? '-';
        const price = order.filled_price ?? order.avg_price ?? order.price ?? '-';
        const side = (order.side || '').toUpperCase();
        const oid = order.order_id || order.id || '';

        const div = document.createElement('div');
        div.className = 'message system-message';
        div.innerHTML = `
              <strong>âœ… ê±°ë˜ ì§‘í–‰</strong><br/>
              <div><b>${ticker}</b></div>
            `;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;

        // ìƒíƒœë°” ì—…ë°ì´íŠ¸
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = `âœ… ê±°ë˜ ì§‘í–‰ ì™„ë£Œ: ${ticker}`;
        statusEl.style.background = '#d4edda';
    }

    // Global variables
    let stockList = [];
    let selectedStock = null;

    // Connect when page loads
    connect();
    loadStockList();

    // Load stock list from API
    async function loadStockList() {
        try {
            const response = await fetch('/api/stocks-by-mcp');

            const data = await response.json();
            stockList = data.stocks;
            populateDropdown(stockList);
        } catch (error) {
            console.error('ì£¼ì‹ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // Populate dropdown with stock list
    function populateDropdown(stocks) {
        const dropdown = document.getElementById('stockDropdown');
        dropdown.innerHTML = '';

        stocks.forEach(stock => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.onclick = () => selectStock(stock);

            item.innerHTML = `
                    <div>
                        <span class="ticker-code">${stock.ticker}</span>
                        <span class="category-badge">${stock.category}</span>
                    </div>
                    <div class="company-name">${stock.name}</div>
                `;

            dropdown.appendChild(item);
        });
    }

    // Toggle dropdown visibility
    function toggleDropdown() {
        const dropdown = document.getElementById('stockDropdown');
        const isVisible = dropdown.style.display === 'block';
        dropdown.style.display = isVisible ? 'none' : 'block';

        if (!isVisible) {
            populateDropdown(stockList); // Show all stocks when opening
        }
    }

    // Select a stock from dropdown
    function selectStock(stock) {
        selectedStock = stock;
        const searchInput = document.getElementById('stockSearch');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const dropdown = document.getElementById('stockDropdown');

        searchInput.value = `${stock.ticker} - ${stock.name}`;
        analyzeBtn.disabled = false;
        dropdown.style.display = 'none';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const container = document.querySelector('.dropdown-container');
        if (!container.contains(event.target)) {
            document.getElementById('stockDropdown').style.display = 'none';
        }
    });

    // Trade analysis request function
    async function requestTradeAnalysis() {
        if (!selectedStock) {
            alert('ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const analyzeBtn = document.getElementById('analyzeBtn');
        const ticker = selectedStock.ticker;

        // Disable button and show loading
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'ë¶„ì„ ì¤‘...';
        document.getElementById('status').innerHTML = `ğŸ“Š ${ticker} ë¶„ì„ ì¤‘...`;
        document.getElementById('status').style.background = '#cce5ff';

        // Add analysis request message to chat
        const chatContainer = document.getElementById('chatContainer');
        const requestDiv = document.createElement('div');
        requestDiv.className = 'message system-message';
        requestDiv.innerHTML = `<strong>ğŸ“Š ë¶„ì„ ìš”ì²­:</strong> ${selectedStock.name} (${ticker}) ì¢…ëª©ì˜ ê±°ë˜ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...`;
        chatContainer.appendChild(requestDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const response = await fetch('/api/trade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ticker: ticker})
            });

            const result = await response.json();

            if (result.status === 'success') {
                const successDiv = document.createElement('div');
                successDiv.className = 'message system-message';

                const header = document.createElement('div');
                header.innerHTML = `<strong>âœ… ì™„ë£Œ:</strong>`;
                successDiv.appendChild(header);

                const pre = document.createElement('pre');
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.margin = '6px 0 0 0';
                pre.textContent = JSON.stringify(result.response, null, 2);
                successDiv.appendChild(pre);

                chatContainer.appendChild(successDiv);

                document.getElementById('status').innerHTML = 'âœ… ì™„ë£Œ - ë‹¤ìŒ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
                document.getElementById('status').style.background = '#d4edda';
            } else if (result.status === 'pending') {
                const pendingDiv = document.createElement('div');
                pendingDiv.className = 'message system-message';
                pendingDiv.innerHTML = `<strong>â¸ ìŠ¹ì¸ ëŒ€ê¸°/ë³´ë¥˜:</strong> ${typeof result.response === 'string' ? result.response : (result.message || 'ìŠ¹ì¸ ì§„í–‰ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.')}`;
                chatContainer.appendChild(pendingDiv);

                document.getElementById('status').innerHTML = 'â¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘...';
                document.getElementById('status').style.background = '#fff3cd';
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message system-message';
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.innerHTML = `<strong>âŒ ë¶„ì„ ì‹¤íŒ¨:</strong> ${result.error}`;
                chatContainer.appendChild(errorDiv);

                document.getElementById('status').innerHTML = 'âŒ ë¶„ì„ ì‹¤íŒ¨';
                document.getElementById('status').style.background = '#f8d7da';
            }

        } catch (error) {
            console.error('ë¶„ì„ ìš”ì²­ ì˜¤ë¥˜:', error);

            const errorDiv = document.createElement('div');
            errorDiv.className = 'message system-message';
            errorDiv.style.background = '#f8d7da';
            errorDiv.style.color = '#721c24';
            errorDiv.innerHTML = `<strong>âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:</strong> ${error.message}`;
            chatContainer.appendChild(errorDiv);

            document.getElementById('status').innerHTML = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
            document.getElementById('status').style.background = '#f8d7da';
        } finally {
            // ë²„íŠ¼ ì¬í™œì„±í™” ë° ì„ íƒ ì´ˆê¸°í™”
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ë¶„ì„ ìš”ì²­';
            selectedStock = null;
            document.getElementById('stockSearch').value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }
</script>
</body>

</html>